name: Spring Boot K8s Workflow

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  DOCKER_IMAGE: spring-boot-k8s-demo
  DOCKER_TAG: latest

jobs:
  build-and-deploy:
    runs-on: self-hosted
    steps:
    - uses: actions/checkout@v2

    - name: Set up JDK 17
      uses: actions/setup-java@v2
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Build with Maven
      run: ./mvnw clean package -DskipTests

    - name: Configure Minikube environment
      run: |
        eval $(minikube docker-env)
        echo "Using Minikube's Docker daemon"

    - name: Build Docker image
      run: |
        docker build -t ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }} .
        echo "Docker image built successfully"

    - name: Deploy to Minikube
      run: |
        # Apply the Kubernetes configuration
        kubectl apply -f k8s.yaml
        
        # Wait for the deployment to be ready
        kubectl rollout status deployment/spring-boot-k8s-demo
        
        # Get the service URL
        minikube service spring-boot-k8s-demo --url
        
        # Display pod status
        kubectl get pods
        
        echo "Deployment completed successfully"
